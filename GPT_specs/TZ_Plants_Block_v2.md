# ТЗ-2: Расширение блока «Растения»

> Цель: улучшить пользовательский опыт, визуализацию и управляемость каталога “Растения” без изменения основной логики.  
> Все решения основаны на текущей реализации раздела.

---

## 🌿 1. Интеллектуальные и контентные улучшения

### 1.1. Кнопка “Сгенерировать описание”
- Добавить кнопку **«Сгенерировать статью»** под блоком статьи.
- При нажатии:
  - Отправляется **вебхук** (POST-запрос) на заранее заданный URL (n8n workflow).
  - В тело запроса передаётся JSON:
    ```json
    {
      "plant_name": "Фикус каучуконосный",
      "plant_id": 12
    }
    ```
  - После успешного ответа отображается toast “Запрос отправлен”.
- В разделе **Настройки растений** добавить поле для ввода URL вебхука:
  - поле `n8n_generate_description_url`;
  - хранить в БД (таблица `plants_settings`).
- В дальнейшем можно использовать для других автоматизаций.

---

## 🎨 2. Улучшения визуала и UX

### 2.1. Похожие растения
- На странице растения, под статьёй, выводить блок **“Похожие растения”** (3–5 карточек).
- Логика подбора:
  - совпадает хотя бы одно из полей: `family`, `light_id`, `humidity_id`, `watering_id`;
  - исключить текущее растение;
  - случайный порядок.
- Отображение — как мини-карточки (фото + название).

### 2.2. “Идеальные соседи”
- Показывать бейдж **«Совместимо с...»** рядом с паспортными характеристиками, если у растения найдены другие растения с совпадающими условиями ухода (light, humidity, watering).
- При наведении — popup с 2–3 названиями совместимых растений.

### 2.3. Визуальные бейджи
- На карточках и в детальном просмотре использовать иконки/эмодзи:
  - ☀️ Свет
  - 💧 Полив
  - 💨 Влажность
  - 🧪 Токсичность
  - 🌸 Цветение
- Tailwind + цветовая кодировка бейджей по категориям.

### 2.4. Анимированные карточки
- При фильтрации или подгрузке карточки появляются с fade/slide-анимацией (`framer-motion`).
- Добавить мягкий skeleton при смене фильтров.

### 2.5. Галерея с drag’n’drop
- В карточке растения, для галереи фото:
  - реализовать drag’n’drop сортировку;
  - при изменении порядка сохранять поле `order` в таблице `plant_images`.

---

## ⚙️ 3. Управление и структура

### 3.1. История изменений
- Добавить таблицу `plants_history`:
  ```sql
  CREATE TABLE plants_history (
    id SERIAL PRIMARY KEY,
    plant_id INT REFERENCES plants(id),
    user_id INT,
    field TEXT,
    old_value TEXT,
    new_value TEXT,
    changed_at TIMESTAMPTZ DEFAULT now()
  );
  ```
- Логировать при PATCH-обновлении растения:
  - изменённые поля,
  - пользователь (если доступен),
  - время.
- Пока без интерфейса — только запись в таблицу.

### 3.2. Черновик / Опубликовано
- В таблицу `plants` добавить поле:
  ```sql
  is_published BOOLEAN DEFAULT false
  ```
- В списке `/plants` показывать только опубликованные (is_published = true).  
- В админском интерфейсе (у `plants_admin`) — чекбокс “Опубликовать”.

### 3.3. Группы / категории растений
- Добавить справочник:
  ```sql
  CREATE TABLE dict_categories (
    id SERIAL PRIMARY KEY,
    name TEXT UNIQUE NOT NULL
  );
  ```
- В таблицу `plants` добавить `category_id INT REFERENCES dict_categories(id)`.
- Отображать категорию в карточке растения и в фильтрах.

---

## 📊 4. Визуализация и аналитика

### 4.1. Диаграмма ухода
- В карточке растения, под паспортом, добавить мини-график:
  - ось X — месяцы (1–12),
  - ось Y — уровень активности (полив / цветение / подкормка).
- Использовать библиотеку **Recharts**.
- Базовые данные — статичные (по типу растения), позже можно вынести в настройки.

---

## 💾 5. Фильтры и поиск

### 5.1. Фильтр “С фото / Без описания”
- В панель фильтров добавить чекбоксы:
  - “Показывать только с фото”
  - “Показывать без статьи”
- Реализация: фильтрация по `main_image_url IS NOT NULL` и `article.content_text IS NULL`.

### 5.2. Кнопка “Добавить похожее”
- В карточке растения добавить кнопку “Добавить похожее”.
- При клике:
  - создаётся новый `plant` с копией всех справочных полей (light, watering, soil, humidity, temperature),
  - название — “Копия {старое название}”,
  - редирект на страницу редактирования нового растения.

---

## 🧩 6. Контент и пользовательский опыт

### 6.1. Markdown-поддержка в статье
- В редакторе статьи разрешить **markdown-разметку**: таблицы, ссылки, выделения.
- Реализация: расширить текущий rich-редактор (через `react-markdown` при рендере).

### 6.2. Тематические подборки
- Добавить новый фильтр “Подборка” (динамический):
  - “Легкие в уходе”
  - “Для спальни”
  - “Цветущие зимой”
  - “Нетоксичные”
- Это предустановленные фильтры, применяемые при нажатии одной кнопки.

---

## 🔧 7. Настройки раздела “Растения”

Добавить новую страницу `/plants/settings` (расширить существующую):
- Поле **n8n webhook URL** (строка).
- Блок **Справочники**:
  - Свет
  - Полив
  - Почва
  - Влажность
  - Температура
  - Локации
  - Категории
- Каждая секция — collapsible, CRUD через API `/api/plants/dicts/*`.
- Поля сохраняются в таблице `plants_settings` (новая таблица).

---

## ✅ 8. Принятие изменений

1. Все пункты UI отображаются корректно на разных устройствах.  
2. Анимации не влияют на производительность.  
3. История изменений записывается при обновлении растения.  
4. Вебхук в n8n вызывается корректно, данные приходят.  
5. Фильтры “С фото / Без статьи” работают.  
6. Добавление похожего растения копирует данные и создаёт новую карточку.  
7. Категории и подборки фильтруются корректно.  
8. Markdown-контент рендерится без ошибок.  
9. Новая страница “Настройки растений” сохраняет URL вебхука и справочники.
