# ТЗ‑3.3: Интеграция связей и общая страница «Проблемы и решения»

> Цель: объединить разделы «Вредители», «Заболевания» и «Лекарства» в общую систему, связать все сущности и реализовать единый интерфейс для анализа проблем растений.

---

## 1. Новая страница `/problems`

### 1.1. Назначение
- Единый каталог всех проблемных сущностей (вредители, болезни, лекарства).
- Фильтровать по типу и по привязке к растениям.
- Универсальный поиск по названию.

### 1.2. UI
- Верхняя панель: поле поиска, селектор типа (🐛/🧫/💊/Все), чекбокс «Только связанные с растениями».
- Сетка карточек разных типов с цветовой дифференциацией.
- Клик по карточке → переход на детальную страницу сущности.

---

## 2. Взаимосвязи

### 2.1. Таблицы «проблема ↔ лекарство»
```sql
CREATE TABLE pest_medicine (
  pest_id INT REFERENCES pests(id) ON DELETE CASCADE,
  medicine_id INT REFERENCES medicines(id) ON DELETE CASCADE,
  PRIMARY KEY (pest_id, medicine_id)
);

CREATE TABLE disease_medicine (
  disease_id INT REFERENCES diseases(id) ON DELETE CASCADE,
  medicine_id INT REFERENCES medicines(id) ON DELETE CASCADE,
  PRIMARY KEY (disease_id, medicine_id)
);
```

### 2.2. Отображение связей
- На странице **вредителя**: блок «Рекомендуемые лекарства» (список из `pest_medicine`).
- На странице **заболевания**: блок «Рекомендуемые лекарства» (из `disease_medicine`).
- На странице **лекарства**: блоки «Против вредителей» и «Против заболеваний» (обратные связи).
- На карточке **растения** (из ТЗ‑3.2): секция «Рекомендованные лекарства» — объединение связей вредителей/болезней текущего растения.

---

## 3. Расширение API

### 3.1. Универсальный список
`GET /api/problems?type=all|pest|disease|medicine&query=&onlyLinked=true|false&limit=24&offset=0`

**Ответ:**
```json
{
  "items": [
    {"type":"pest", "id":1, "slug":"...", "name":"...", "danger_level":"..."},
    {"type":"disease","id":5, "slug":"...", "name":"...", "disease_type":"..."},
    {"type":"medicine","id":8,"slug":"...","name":"...","medicine_type":"..."}
  ],
  "total": 120
}
```

### 3.2. Универсальная деталь (опционально)
`GET /api/problems/:type/:slug` — проксирует на соответствующий эндпоинт сущности.

### 3.3. CRUD связей лекарств
- `POST /api/pests/:id/medicines` body: `{ "ids":[1,2] }`
- `DELETE /api/pests/:id/medicines/:medicineId`
- `POST /api/diseases/:id/medicines` body: `{ "ids":[3,4] }`
- `DELETE /api/diseases/:id/medicines/:medicineId`

Права: `plants_admin`.

---

## 4. Визуальные элементы

- Цвета карточек как в ТЗ‑3.1.
- Бейджи «Связано с N растениями / M лекарствами».
- Иконки типа в углу карточки.

---

## 5. Общая статистика

- Вверху `/problems` — панель:
  - Всего вредителей: N
  - Всего болезней: N
  - Всего лекарств: N
- Клик по карточке статистики применяет фильтр по типу.

---

## 6. Логи изменений

- Для всех трёх типов вести таблицы `*_history` (INSERT/UPDATE/DELETE).
- Логировать CRUD связей с лекарствами.

---

## 7. Принятие работ

1. `/problems` отображает все типы карточек, фильтры и поиск работают.
2. Страницы сущностей показывают связанные лекарства; обратные связи видны на лекарстве.
3. В карточке растения отображаются рекомендованные лекарства по связям.
4. CRUD связей лекарств работает, права соблюдены.
