# ТЗ: Раздел «Бухгалтерия» для Personal Portal (React 18 + Vite + Tailwind / Express + PostgreSQL)

**Контекст проекта**
- Frontend: React 18 + Vite + Tailwind. Маршрутизация в `src/App.jsx`, общий каркас `PageShell`, тёмная тема, RBAC через `AuthContext`.
- Backend: Express (`backend/index.js`), REST `/api/*`.
- БД: PostgreSQL.
- Уже есть push‑уведомления через Service Worker, синхронизация и RBAC.
- Требуется: новый раздел **«Бухгалтерия»** с дашбордом и подстраницами: **Платежи**, **Траты**, **Доходы**, **Категории**, **Настройки**.


---

## 1) Цели и основные функции

1. **Дашборд**
   - Карточки: Доходы за месяц, Расходы за месяц, Баланс (Доходы–Расходы), Ближайшие платежи (7 дней), Подписки (остаток дней).
   - Диаграмма «Расходы по категориям» (текущий месяц).
   - Переключатели «Показывать на дашборде» (чекбоксы для блоков).

2. **Платежи**
   - Типы: *Ипотека*, *Кредит*, *Коммунальные* (бессрочные), *Аренда парковки*, *Связь*, *Подписки*.
   - Для кредитов/ипотеки: ставка, срок, расчёт аннуитетного платежа и остатка, история оплат (как транзакции).
   - Коммунальные: каждый месяц 1-го числа создавать «ожидаемую запись» и просить ввести сумму (через уведомление).
   - Подписки: ссылка на сервис, дата продления, «Осталось дней …». Если <3 — подсветка.
   - История оплат — таб на карточке платежа (тянется из `transactions` по `payment_id`).

3. **Траты / Транзакции**
   - Импорт (MVP — заглушка).
   - Таблица с фильтрами/поиском, сортировкой и пагинацией.
   - Инлайн-редактирование: сумма, категория, дата.
   - Поддержка полей из выгрузки банка: дата, описание, категория (маппинг), сумма/валюта операции, сумма/валюта счёта, код авторизации, MCC.

4. **Доходы**
   - Источники, суммы, периодичность (monthly/quarterly/custom N days), дата `next_date`.
   - График поступлений и прогноз (месяц/год).

5. **Категории**
   - Пользовательские и системные; тип `expense`/`income`, цвет, `mcc_mask`.
   - Нельзя удалять системные.

6. **UI/UX**
   - Единый стиль портала, тёмная тема, адаптив. Экспорт сейчас не нужен.

7. **Доступ**
   - Раздел виден авторизованному пользователю. RBAC: `accounting:view`, `accounting:edit`, `accounting:admin`.


---

## 2) Навигация и экраны (Frontend)

```
/accounting
  - Dashboard
/accounting/payments
  - list + create/edit
/accounting/transactions
  - list + inline edit + filters + upload stub
/accounting/incomes
  - list + create/edit
/accounting/categories
  - list + create/edit
/accounting/settings
  - dashboard widgets toggles
```
Компонентные блоки:
- `KPICard`, `PieExpensesByCategory`, `UpcomingPaymentsList`, `SubscriptionsList`,
- `PaymentsForm`, `TransactionsTable` (+ инлайн редакторы), `IncomeForm`, `CategoryForm`.


---

2.1 Dashboard
- Компоненты:
 - <KPICard title="Доходы (мес)">, <KPICard title="Расходы (мес)">, <KPICard title="Баланс">.
 - <UpcomingPaymentsList rangeDays={7}>.
 - <SubscriptionsList highlightBelowDays={3}>.
 - <PieExpensesByCategory month={current}>.
- Переключатели блоков (сохранение в dashboard_preferences).

2.2 Платежи
- Таблица с фильтром по типу + поиск.
- Форма:
 - Общие: title, type, is_active, notes.
 - Ипотека/Кредит: principal_total, interest_rate_apy, term_months, start_date, day_of_month, is_annuity=true, account_currency.
 - Коммунальные: is_indefinite=true, billing_day=1, last_amount, vendor.
 - Аренда парковки/Связь: amount, billing_period='monthly', billing_day, provider.
 - Подписка: service_url, renewal_date, periodicity, amount, currency.
- История оплат — таб на карточке платежа (подтягивается из transactions по payment_id).

2.3 Траты / Транзакции
- Кнопка «Импорт файла» (заглушка: приём файла, отображение «в разработке»).
- Таблица:
 - Колонки: дата, описание, категория, сумма (операции и счёта), валюта(ы), MCC, код авторизации, теги/связи.
 - Фильтры: период, категория, сумма (диапазон), MCC, текстовый поиск по описанию.
 - Инлайн-редактирование: transaction_date, category_id, amount_account, currency_account.
- Пагинация, сортировка по дате/сумме.

2.4 Доходы
- Таблица + форма:
 - source_name, amount, currency, periodicity (monthly/quarterly/custom N days), next_date, is_active.
- Блок «Прогноз» (на текущий месяц/год) и «График поступлений» (bar chart по датам).

2.5 Категории
- CRUD: name, type (expense | income), color_hex, is_system (нельзя удалять системные), mcc_mask (опц.).

2.6 Settings (Dashboard widgets)
- Чекбоксы: KPI, Диаграмма категорий, Ближайшие платежи, Подписки, Прогноз доходов. Сохранение в БД.


## 3) Архитектура БД (PostgreSQL)

> Все таблицы содержат `created_at timestamptz default now()`, `updated_at timestamptz default now()` и триггер авто‑апдейта.

```sql
-- Пользователь (если уже есть - пропустить)
CREATE TABLE IF NOT EXISTS app_user (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE,
  display_name TEXT
);

-- Категории
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES app_user(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('expense','income')),
  color_hex TEXT,
  is_system BOOLEAN NOT NULL DEFAULT FALSE,
  mcc_mask TEXT,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
CREATE UNIQUE INDEX categories_user_name_uk ON categories(user_id, name);

-- Типы платежей
DO $$ BEGIN
  CREATE TYPE payment_type AS ENUM ('mortgage','loan','utilities','parking_rent','mobile','subscription');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- Платежи (шапка)
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES app_user(id) ON DELETE CASCADE,
  type payment_type NOT NULL,
  title TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  notes TEXT,
  -- Общие параметры биллинга
  billing_period TEXT,     -- 'monthly','weekly','yearly','custom'
  billing_day INT,         -- для monthly: день месяца
  start_date DATE,
  end_date DATE,
  service_url TEXT,
  provider TEXT,
  -- Кредит/ипотека
  principal_total NUMERIC(14,2),
  interest_rate_apy NUMERIC(6,3),  -- годовая, %
  term_months INT,
  day_of_month INT,
  is_annuity BOOLEAN,
  account_currency TEXT,
  -- Коммунальные
  is_indefinite BOOLEAN DEFAULT FALSE,
  last_amount NUMERIC(14,2),
  -- Подписки
  renewal_date DATE,
  amount NUMERIC(14,2),
  currency TEXT,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
CREATE INDEX payments_user_type_idx ON payments(user_id, type);
CREATE INDEX payments_renewal_idx ON payments(renewal_date);

-- Транзакции (расходы/доходы)
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES app_user(id) ON DELETE CASCADE,
  transaction_date DATE NOT NULL,
  description TEXT,
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  payment_id UUID REFERENCES payments(id) ON DELETE SET NULL,
  amount_operation NUMERIC(14,2),
  currency_operation TEXT,
  amount_account NUMERIC(14,2),
  currency_account TEXT,
  authorization_code TEXT,
  mcc TEXT,
  is_income BOOLEAN NOT NULL DEFAULT FALSE,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
CREATE INDEX transactions_user_date_idx ON transactions(user_id, transaction_date DESC);
CREATE INDEX transactions_user_category_idx ON transactions(user_id, category_id);
CREATE INDEX transactions_user_payment_idx ON transactions(user_id, payment_id);
CREATE INDEX transactions_search_idx ON transactions USING GIN (to_tsvector('simple', coalesce(description,'')));

-- Доходы (плановые источники)
CREATE TABLE incomes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES app_user(id) ON DELETE CASCADE,
  source_name TEXT NOT NULL,
  amount NUMERIC(14,2) NOT NULL,
  currency TEXT NOT NULL,
  periodicity TEXT NOT NULL,  -- 'monthly','quarterly','custom_ndays'
  n_days INT,                 -- если custom_ndays
  next_date DATE NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
CREATE INDEX incomes_user_next_idx ON incomes(user_id, next_date);

-- Настройки дашборда
CREATE TABLE dashboard_preferences (
  user_id UUID PRIMARY KEY REFERENCES app_user(id) ON DELETE CASCADE,
  show_kpis BOOLEAN DEFAULT TRUE,
  show_pie_categories BOOLEAN DEFAULT TRUE,
  show_upcoming_payments BOOLEAN DEFAULT TRUE,
  show_subscriptions BOOLEAN DEFAULT TRUE,
  show_income_forecast BOOLEAN DEFAULT TRUE,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 3.1 Маппинг импорта банка → `transactions`
Колонки Excel: `Дата транзакции`, `Содержание операции`, `Категория`, `Сумма в валюте операции`, `Валюта операции`, `Сумма в валюте счета`, `Валюта счета`, `Код авторизации`, `MCC`.
- `transaction_date` ← «Дата транзакции»
- `description` ← «Содержание операции»
- `category_id` ← по названию категории (создавать при отсутствии)
- `amount_operation` / `currency_operation`
- `amount_account` / `currency_account`
- `authorization_code`, `mcc`
- `is_income` ← по типу категории или признаку суммы (логика в импортере)  
*Категории пользователь управляет на странице «Категории». Поддержать полуавтокатегоризацию по `mcc_mask` и ключевым словам.*


---

## 4) Фоновые задачи и уведомления

Реализовать cron/планировщик (node-cron/Agenda/pg_cron).

1. **Коммунальные** — каждый месяц 1-го числа 08:00:
   - создать «ожидаемую» транзакцию с `payment_id` коммунального платежа и уведомить пользователя;
   - `description='Коммунальные — введите сумму'`, `amount_* = NULL`, `is_income=false`.

2. **Подписки** — ежедневно в 09:00:
   - рассчитать `days_left = renewal_date - today`; если `<3` и `is_active`, отправить push, подсветить запись на фронте.

3. **Ипотека/Кредит** — ежедневно в 09:00:
   - напоминание за 3 дня до `day_of_month`; расчёт платежа/остатка выполняется при отображении (не хранить помесячный график).

4. **Доходы** — ежедневно в 09:30:
   - если `next_date=today` и `is_active`, отправить push и сдвинуть `next_date` на период (месяц/квартал/N дней).

Пример push payload:
```json
{ "title": "Подписка скоро спишется", "body": "Spotify — осталось 2 дня", "url": "/accounting/payments" }
```


---

## 5) Расчёты и утилиты (Backend)

### 5.1 Аннуитет
Формулы:

- Месячная ставка r = apy / 12 / 100.
- Платёж: A = P * r / (1 - (1 + r)^(-n)), где P = principal_total, n = term_months.
- Остаток на месяц k: balance_k = P * (1 + r)^k - A * ( (1 + r)^k - 1 ) / r.
- Для отчётов на месяц — вычислять текущий k как число месяцев с start_date.

### 5.2 Остаток дней по подписке
`days_left = ceil((renewal_date - today)/день)`

### 5.3 Агрегаты 

- Расходы (мес): SUM(amount_account) WHERE is_income=false AND date in current_month.
- Доходы (мес): SUM(amount_account) WHERE is_income=true AND date in current_month.
- Категории (pie): SUM(amount_account) GROUP BY category_id WHERE is_income=false AND month=current.
- Ближайшие платежи: все payments активные с ближайшей датой (см. тип), + подписки с days_left <= 7.

SQL-примеры
```sql
-- Расходы по категориям за месяц
SELECT c.name, SUM(t.amount_account) AS amount
FROM transactions t
JOIN categories c ON c.id = t.category_id
WHERE t.user_id = $1 AND t.is_income = FALSE
  AND date_trunc('month', t.transaction_date) = date_trunc('month', $2::date)
GROUP BY c.name ORDER BY amount DESC;

-- Доходы/Расходы/Баланс за месяц
WITH m AS (
  SELECT
    SUM(CASE WHEN is_income THEN amount_account ELSE 0 END) AS incomes,
    SUM(CASE WHEN NOT is_income THEN amount_account ELSE 0 END) AS expenses
  FROM transactions
  WHERE user_id=$1 AND date_trunc('month', transaction_date)=date_trunc('month', $2::date)
)
SELECT incomes, expenses, (coalesce(incomes,0)-coalesce(expenses,0)) AS balance FROM m;
```


---

## 6) REST API (контракты)

Base: `/api/accounting/*` (все — за авторизацией, проверять RBAC).

### 6.1 Dashboard
- `GET /dashboard?month=YYYY-MM`
  - Ответ: `{ incomesMonth, expensesMonth, balance, pieByCategory:[{category, amount}], upcomingPayments:[...], subscriptions:[{id,title,days_left,...}] }`

### 6.2 Категории
- `GET /categories`
- `POST /categories` `{ name, type, color_hex, mcc_mask }`
- `PATCH /categories/:id`
- `DELETE /categories/:id` — запрет если `is_system=true`

### 6.3 Платежи
- `GET /payments?type=&active=`
- `POST /payments`
- `GET /payments/:id`
- `PATCH /payments/:id`
- `DELETE /payments/:id`
- `GET /payments/:id/history` — транзакции с `payment_id`

### 6.4 Транзакции
- `GET /transactions?from=&to=&category_id=&mcc=&q=&page=&limit=&sort=`
- `POST /transactions`
- `PATCH /transactions/:id` — поля: `transaction_date`, `category_id`, `amount_account`, `currency_account`
- `DELETE /transactions/:id`
- `POST /transactions/import` — заглушка `{status:"stub"}`

### 6.5 Доходы
- `GET /incomes`
- `POST /incomes` `{ source_name, amount, currency, periodicity, n_days?, next_date, is_active }`
- `PATCH /incomes/:id`
- `DELETE /incomes/:id`
- `GET /incomes/forecast?period=month|year` → `{ total, items:[{date, amount}] }`

### 6.6 Настройки дашборда
- `GET /settings/dashboard`
- `PATCH /settings/dashboard` `{ show_kpis?, show_pie_categories?, show_upcoming_payments?, show_subscriptions?, show_income_forecast? }`


---

## 7) RBAC

- `accounting:view` — просмотр страниц и данных.
- `accounting:edit` — CRUD транзакций, категорий, доходов, платежей.
- `accounting:admin` — настройки дашборда, ручной запуск фоновых задач.

Middleware проверяет наличие прав.


---

## 8) Frontend: структура и ключевые компоненты

```
src/
  pages/accounting/
    Dashboard.jsx
    Payments.jsx
    Transactions.jsx
    Incomes.jsx
    Categories.jsx
    Settings.jsx
  components/accounting/
    KPICard.jsx
    PieExpensesByCategory.jsx
    UpcomingPaymentsList.jsx
    SubscriptionsList.jsx
    PaymentsForm.jsx
    TransactionsTable.jsx
    InlineAmountEditor.jsx
    IncomeForm.jsx
    CategoryForm.jsx
```
- Графики: `recharts` (pie/bar).
- Формы: `react-hook-form` + `zod`.
- Таблицы: сортировка, фильтры, инлайн‑редакторы.


---

## 9) Системные категории (миграцией)

Создать при первом запуске (если отсутствуют):
- `Коммунальные` (`expense`, `is_system=true`)
- `Ипотека` (`expense`, `is_system=true`)
- `Кредит` (`expense`, `is_system=true`)
- `Связь` (`expense`, `is_system=true`)
- `Подписки` (`expense`, `is_system=true`)
- `Зарплата` (`income`, `is_system=true`)


---

## 10) Производительность и индексы

- Индексы на: даты, категории, типы платежей, `renewal_date`, полнотекст по `description`.
- Пагинация: предпочтительно keyset по `(transaction_date, id)` для длинных списков.
- Отдельные выборки для агрегатов (избегать тяжёлых `JOIN` с большим объёмом).


---

## 11) Нотификации (push)

Использовать существующий SW. Триггеры:
- коммунальные 1-го числа;
- подписки за 3 дня до списания;
- кредиты/ипотека за 3 дня до дня платежа;
- доходы в `next_date`.


---

## 12) Валидации и правила редактирования

- `is_system` у системных категорий неизменяем и недоступен для удаления.
- Инлайн‑редактирование транзакции ограничено: дата/категория/сумма/валюта счёта.
- Связь `payment_id` менять только через страницу детализации транзакции.
- Суммы расходов и доходов храним положительными, отличаем по флагу `is_income` (проще для агрегатов).


---

## 13) Обработка валют

- Храним обе суммы и валюты из выгрузки (`operation` и `account`).
- Агрегаты считаются по `amount_account/currency_account`. Если валют несколько — **MVP**: показывать агрегаты по базовой валюте пользователя (конфиг портала) и игнорировать остальные строки (в будущем — конвертация).


---

## 14) Тест‑данные (seed)

- Несколько `payments` каждого типа (ипотека/кредит/коммуналка/подписка/связь/парковка).
- 20–50 `transactions` (разных месяцев), часть связать `payment_id`.
- 2–3 `incomes`, 8–10 `categories`.
- Данные текущего и прошлого месяца для наглядности дашборда.


---

## 15) Пошаговая реализация (итерации)

1. Миграции БД (таблицы, типы, индексы, системные категории, `dashboard_preferences`).
2. API: категории → транзакции → платежи → доходы → дашборд.
3. UI страниц + диаграммы + тёмная тема.
4. Планировщик фоновых задач.
5. Интеграция push‑уведомлений.
6. Импорт (заглушка) + уведомления/тосты.
7. Оптимизация запросов и UX‑полировка.


---

## 16) Гайды по коду (фрагменты)

### 16.1 Node utils (финансовые формулы)
```js
// backend/lib/finance.js
export function annuityPayment(principal, apy, termMonths) {
  const r = apy / 12 / 100;
  if (r === 0) return principal / termMonths;
  return principal * r / (1 - Math.pow(1 + r, -termMonths));
}
export function annuityBalance(principal, apy, termMonths, k) {
  const r = apy / 12 / 100;
  if (r === 0) return principal - (principal/termMonths) * k;
  const A = annuityPayment(principal, apy, termMonths);
  return principal * Math.pow(1+r, k) - A * ((Math.pow(1+r, k)-1) / r);
}
export function daysLeft(dateStr) {
  const today = new Date(); today.setHours(0,0,0,0);
  const target = new Date(dateStr); target.setHours(0,0,0,0);
  return Math.ceil((target - today) / (1000*60*60*24));
}
```

### 16.2 SQL агрегаты
```sql
-- Топ-5 категорий по расходам за месяц
SELECT c.name, SUM(t.amount_account) AS total
FROM transactions t
JOIN categories c ON c.id=t.category_id
WHERE t.user_id=$1 AND t.is_income=FALSE
  AND date_trunc('month', t.transaction_date)=date_trunc('month', $2::date)
GROUP BY c.name ORDER BY total DESC LIMIT 5;
```


---

## 17) Критерии готовности (DoD)

- Раздел «Бухгалтерия» доступен из меню; страницы открываются.
- Дашборд показывает актуальные агрегаты текущего месяца; видимость блоков сохраняется в БД.
- CRUD: платежи (все типы), категории, доходы; транзакции — лист/фильтры/поиск/инлайн‑редактирование.
- Аннуитетные расчёты и остаток долга отображаются корректно.
- Коммунальные — 1-го числа создаётся ожидаемая запись + приходит push.
- Подписки подсвечиваются за 3 дня до списания + push.
- Доходы: прогноз и график работают.
- RBAC соблюдается, эндпойнты защищены.
- Адаптив + тёмная тема соответствуют стилю портала.


---

## 18) Что откладываем

- Полный импорт Excel/CSV/JSON и авто‑категоризация.
- Конвертация валют и мультивалютные отчёты.
- Бюджеты/лимиты и расширенные отчёты по периодам.


---

## Приложение A. Пример DTO (TypeScript)

```ts
// Transaction
type Transaction = {
  id: string;
  transaction_date: string; // YYYY-MM-DD
  description?: string;
  category_id?: string;
  payment_id?: string;
  amount_operation?: number;
  currency_operation?: string;
  amount_account?: number;
  currency_account?: string;
  authorization_code?: string;
  mcc?: string;
  is_income: boolean;
};

// Payment
type Payment = {
  id: string;
  type: 'mortgage'|'loan'|'utilities'|'parking_rent'|'mobile'|'subscription';
  title: string;
  is_active: boolean;
  notes?: string;
  billing_period?: 'monthly'|'weekly'|'yearly'|'custom';
  billing_day?: number;
  start_date?: string;
  end_date?: string;
  service_url?: string;
  provider?: string;
  principal_total?: number;
  interest_rate_apy?: number;
  term_months?: number;
  day_of_month?: number;
  is_annuity?: boolean;
  account_currency?: string;
  is_indefinite?: boolean;
  last_amount?: number;
  renewal_date?: string;
  amount?: number;
  currency?: string;
};

// Income (plan)
type Income = {
  id: string;
  source_name: string;
  amount: number;
  currency: string;
  periodicity: 'monthly'|'quarterly'|'custom_ndays';
  n_days?: number;
  next_date: string; // YYYY-MM-DD
  is_active: boolean;
};
```
