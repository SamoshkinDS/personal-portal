# Домашняя страница и дерево задач

## Обзор раздела
- Страница `Home` (`/`) показывает приветственный экран с быстрыми ссылками и древовидным списком задач, который заменил локальное хранение на backend API. 【F:src/pages/Home.jsx†L1-L68】
- Быстрые ссылки ведут к аналитике, AI, документации и VPN; структура задаётся массивом `quickLinks`. 【F:src/pages/Home.jsx†L8-L24】
- Задачи получают данные через `apiAuthFetch('/api/todos')` и собираются в дерево функцией `buildTree`, которая опирается на поля `parent_id` и `position`. 【F:src/pages/Home.jsx†L70-L118】【F:backend/routes/todos.js†L18-L54】

## Структура данных и бэкенд
- Таблица `user_todos` содержит `parent_id` и `position`, что позволяет формировать иерархию и управлять порядком в пределах ветки. 【F:backend/index.js†L52-L84】
- REST API `/api/todos` поддерживает CRUD, обновление родителя и позиции, а также защищён `authRequired`. PATCH запросы проверяют владение родительскими задачами и запрещают циклические ссылки. 【F:backend/routes/todos.js†L1-L120】
- При загрузке компонент `Home` преобразует плоский список в дерево, сортируя элементы по `position` и присваивая индексы. Дополнительные утилиты (`cloneNode`, `assignPositions`, `collectTreeOrder`) хранятся в том же файле. 【F:src/pages/Home.jsx†L26-L118】【F:src/pages/Home.jsx†L320-L392】

## Пользовательские действия
- **Добавление**: корневые задачи создаются через форму вверху (`handleCreateRoot`), вложенные — через модальные окна `openAddModal` / `handleAddSubmit`. После успешного POST список обновляется, а раздел родителя автоматически раскрывается. 【F:src/pages/Home.jsx†L200-L252】
- **Редактирование и удаление**: `openEditModal`, `openDeleteModal` запускают модальные окна, действия отправляются PATCH/DELETE запросами. 【F:src/pages/Home.jsx†L252-L288】
- **Отметка выполнения**: `handleToggle` обновляет локальное состояние и отправляет PATCH, при ошибке дерево перезагружается из API. 【F:src/pages/Home.jsx†L288-L312】

## Drag & Drop и порядок задач
- Состояние `draggingId`/`dragOver` отслеживает перемещение. При drop выполняется `detachNode` → `insertNode`, обновляется родитель и индекс, затем вызывается `syncTreeOrder` для отправки PATCH запросов всем затронутым узлам. 【F:src/pages/Home.jsx†L312-L392】
- Метод `syncTreeOrder` собирает новый порядок через `collectTreeOrder` и параллельно отправляет PATCH для каждой задачи. При ошибке дерево перечитывается из API. 【F:src/pages/Home.jsx†L320-L360】
- Drop‑зоны (`DropZone`) подсвечивают возможные позиции (`before`, `after`, `child`) и предотвращают перемещение элемента внутрь самого себя. 【F:src/pages/Home.jsx†L360-L436】

## UX‑детали
- Коллапс веток хранится в `collapsed` (Set) и сбрасывается при добавлении дочерних элементов. Пользователь может разворачивать/сворачивать узлы вручную. 【F:src/pages/Home.jsx†L190-L220】【F:src/pages/Home.jsx†L436-L512】
- В верхней панели выводится прогресс: функция `countAllTasks` рассчитывает общее количество задач и выполненных пунктов. 【F:src/pages/Home.jsx†L118-L168】【F:src/pages/Home.jsx†L436-L492】
- Модальные окна реализованы через общий компонент `Modal`, ввод хранится в `modalInput`, а состояние сбрасывается после закрытия. 【F:src/pages/Home.jsx†L170-L212】【F:src/pages/Home.jsx†L512-L612】

## Дальнейшие улучшения
- Возможные направления: real-time синхронизация (через WebSocket), сохранение фильтров/поиска, массовые операции и интеграция с календарём. Эти задачи отражены в новых промтах (`docs/CODEX_PROMPTS_v_2.md`).
