# Блок «Заметки / Настройки»

Ниже описана реализация пользовательского блока заметок на странице `/docs`, используемая структура базы данных и API, а также поведение интерфейса.

## Архитектура

- **Клиент:** React-компоненты `NotesBlock` и `NotesEditorModal` (`src/components/notes/`). Блок подключается в `src/pages/Docs.jsx`.
- **Редактор:** TinyMCE с поддержкой форматирования, цветовых стилей, таблиц, цитат, код-блоков, изображений и ссылок.
- **Бэкенд:** REST-роут `backend/routes/notes.js`, подключённый к Express-приложению.
- **Хранилище:** PostgreSQL-таблица `notes`, создаётся миграцией `backend/db/migrations/20251108_create_notes.sql` и дублируется в авто-инициализации `backend/index.js`.

## Модель данных

```sql
CREATE TABLE notes (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  content TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX idx_notes_updated_at ON notes(updated_at DESC);
```

- `title` — обязательный заголовок карточки.
- `description` — краткий анонс (в UI ограничен 200 символами).
- `content` — HTML, полученный из TinyMCE и очищенный на сервере.
- `updated_at` обновляется при каждом `PUT`.

## API

Все запросы требуют авторизации через Bearer-токен. Создание/редактирование/удаление доступны только пользователям с ролью `ALL` или разрешением `admin_access`.

| Метод | Путь | Назначение |
|-------|------|------------|
| `GET` | `/api/notes` | Список заметок, отсортированный по `updated_at DESC`. Возвращает `id`, `title`, `description`, `created_at`, `updated_at`. |
| `GET` | `/api/notes/:id` | Полная заметка с полем `content`. |
| `POST` | `/api/notes` | Создаёт заметку. Тело: `{ title, description?, content? }`. |
| `PUT` | `/api/notes/:id` | Обновляет существующую запись; тело аналогично `POST`. |
| `DELETE` | `/api/notes/:id` | Удаляет заметку после подтверждения. |

Сервер очищает HTML через `sanitize-html`, оставляя только теги форматирования, таблицы, изображения и ссылки. Атрибут `style` ограничен (цвет, фон, размер шрифта, выравнивание, декор текста).

## Поведение интерфейса

### Размещение и список

- Компонент `NotesBlock` отрисовывается внизу страницы `/docs`.
- Карточки показывают заголовок, описание и дату последнего изменения. Сортировка выполняется по `updated_at`.
- Нажатие на карточку открывает модальное окно просмотра (`NoteViewerModal`).

### Просмотр заметки

- Модальное окно выводит форматированный HTML (`.note-content` стилизован в `src/index.css`).
- При отображении контент дополнительно разбирается: если ссылка указывает на изображение (`jpg/png/gif/webp`) — она автоматически заменяется на `<img>`. Ссылки на файлы (`pdf/doc/docx/xls/xlsx/zip/rar/ppt/pptx`) получают класс `note-download-link`, чтобы выглядеть как кнопки скачивания.

### Создание и редактирование

- Кнопка «Добавить заметку» доступна только администратору.
- Форма открывается в `NotesEditorModal` и содержит поля: заголовок, краткое описание, основной текст.
- TinyMCE (`@tinymce/tinymce-react`) инициализируется с плагинами `table`, `image`, `link`, `codesample`, `lists`, `advlist` и др. Панель предоставляет:
  - жирный/курсив/подчёркивание/зачёркивание;
  - выбор блоков, шрифта и размера;
  - цвет/фон текста;
  - цитаты, списки, код-блоки;
  - вставку изображений и ссылок (в том числе S3-URL);
  - расширенное меню таблиц (создание, удаление, управление строками/столбцами).

### Удаление

- Кнопка «Удалить» отображается на карточке для администратора.
- При нажатии открывается модальное подтверждение с текстом из ТЗ.
- После успешного удаления список обновляется локально и запись вычёркивается из кэша.

## Ключевые файлы

- `backend/routes/notes.js` — все CRUD-эндпоинты, санитайзер контента.
- `backend/index.js` — регистрация роута и создание таблицы.
- `src/components/notes/NotesBlock.jsx` — список, просмотр, управление состоянием, обработка ссылок.
- `src/components/notes/NotesEditorModal.jsx` — форма с TinyMCE инициализацией.
- `src/index.css` — стили для `.note-content`, таблиц и кнопок скачивания.

## Использование S3-ссылок

Пользователь может вставить ссылку через TinyMCE:

- Если URL оканчивается на `jpg/png/gif/webp` — в просмотре это автоматически станет `<img>` (вставки работают как для публичных S3 URL, так и для MinIO Gateway).
- Если URL содержит расширение `pdf/doc/docx/xls/xlsx/zip/rar/ppt/pptx` — ссылка будет отображена как кнопка «Скачать» с названием файла.

Для других расширений ссылка остаётся обычной.

## Тестирование

1. Авторизоваться под администратором.
2. Добавить заметку с таблицей, списками, ссылками на изображения и PDF.
3. Убедиться, что карточка отображается в списке, а просмотр показывает:
   - таблицу с нужным числом строк/столбцов,
   - картинку по S3 URL,
   - кнопку скачивания для PDF.
4. Отредактировать заметку, проверить, что она переместилась в начало списка (по времени обновления).
5. Удалить запись и подтвердить, что модалка предупреждает об окончательном удалении.
